<!DOCTYPE html>
<html>

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="">
    <title>AV-Query</title>
    <!-- Custom Video JS -->

    <head>
        <link href="https://vjs.zencdn.net/7.5.5/video-js.css" rel="stylesheet" />
    </head>
</head>

<body>
    <div id="query">
        <form>
            <div class="form-group">
                <label for="query-file">Query</label>
                <input type="text" class="form-control-file" id="query-file" placeholder="Directory containing query files">
                <button type="button" class="form-control-button" id="query-submit-button">Submit Query</button>
            </div>
        </form>
    </div>
    <div id="matched-videos" style="margin: 0 auto; width: 100px;">
        <div class="row">
            <div class=".col-md-6">
                <table id="matched-videos-group"></table>
            </div>
        </div>
    </div>
    <div id="query-video">
        <video id="query-video" class="video-js" controls preload="auto" width="352" height="288" data-setup='{ "controlBar" : false }'>
        </video>
        <video id="match-video" class="video-js" controls preload="auto" width="352" height="288" data-setup='{ "controlBar" : false }'>
        </video>
        <input type="range" min="0" max="599" value="300" id="myFrameSlider" disabled style="width: 352px;">
    </div>
    <canvas id="myChart" width="352" height="100"></canvas>
    <!-- Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://vjs.zencdn.net/7.5.5/video.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>

    <script>
    var sliderEle = document.getElementById('myFrameSlider');
    if (sliderEle != null) {
        var slider = document.getElementById('myFrameSlider');
        slider.oninput = function() {
            // Move in video to what second we are in (at 30fps) according to the slider
            sliderValue = parseInt(this.value);
            secondsValue = sliderValue / 30;
            var video = videojs('match-video');
            video.currentTime(secondsValue);
        }
    }
    </script>
    <script>
    var videoEle = document.getElementById('match-video');
    if (videoEle != null) {
        var video = videojs('match-video');
        video.on("timeupdate", function() {
            var slider = document.getElementById('myFrameSlider');
            slider.value = video.currentTime() * 30;
        });
    }
    </script>

    <script>
        function display_hist(scores) {

            // Set chart defaults for styling
            Chart.defaults.global.legend.display = false;
            Chart.defaults.scale.ticks.display = false;
            Chart.defaults.scale.gridLines.display = false;
            Chart.defaults.scale.gridLines.tickMarkLength = 0;

            var labels = Array.from(Array(31).keys())
            var ctx = document.getElementById('myChart').getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: scores,
                        fill: true,
                        pointRadius: 0,
                    }],
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                min: 0,
                                max: 1,
                            },
                        }],
                    },
                },
            });
            myChart.canvas.parentNode.style.height = '100px';
            myChart.canvas.parentNode.style.width = '352px';
        }
    </script>
    <!-- Get calculating rank functions -->
    <script type="text/javascript" src="calculate_scores.js"></script>
    <!-- On button click! -->
    <script>
    $("#query-submit-button").click(function() {
        filename = $("#query-file").val();
        $.when(
            $.ajax({
                data: JSON.stringify({ "filename": filename + '.wav' }),
                contentType: 'application/json',
                url: 'http://localhost:5000/audio',
                type: 'POST',
                success: function(result) {
                    console.log(result)
                }
            }),
            $.ajax({
                data: JSON.stringify({ "filename": filename }),
                contentType: 'application/json',
                url: 'http://localhost:5000/color',
                type: 'POST',
                success: function(result) {
                    console.log(result)
                }
            }),
            $.ajax({
                data: JSON.stringify({ "filename": '../data/query/' + filename }),
                contentType: 'application/json',
                url: 'http://localhost:5000/edge_detection',
                type: 'POST',
                success: function(result) {
                    console.log(result)
                }
            })).then(function(wav_scores, color_scores, edge_scores) {

            // Calculate ranked scores for top three 
            final_scores = calculate_cum_scores(wav_scores[0], edge_scores[0], color_scores[0]);
            ranked_files = get_top_ranked_files(final_scores);
            ranked_scores = convert_dist_to_scores(ranked_files); // dict with file --> scores in sorted order

            // Add top matches to dom
            var table = document.getElementById("matched-videos-group");
            while (table.lastChild) {
                table.removeChild(table.lastChild);
            }
            for (var f in ranked_scores) {

                // Add table row to DOM
                var tr = document.createElement('tr');
                tr.onclick = function(fn) { return function() { 
                    db_filepath = "../data/database_videos/" + fn + "/" + fn + ".mp4";

                    // Update match video
                    var match_video = videojs('match-video');
                    match_video.src(db_filepath);

                    display_hist(ranked_scores[fn]); } }(f);
                table.appendChild(tr);

                // Add th filename to DOM
                var th_filename = document.createElement('th');
                tr.appendChild(th_filename);
                th_filename.innerHTML = f;
                th_filename.setAttribute("style", "list-style-position: inside;");

                // Add th score to DOM
                var th_score = document.createElement('th');
                tr.appendChild(th_score);
                th_score.innerHTML = (Math.max(...ranked_scores[f])*100).toFixed(2);
                th_score.setAttribute("style", "list-style-position: inside;");
            }

            display_hist(ranked_scores[Object.keys(ranked_scores)[0]]);

            // Create query mp4
            query_filepath = "../data/query/" + filename + "/" + filename + ".mp4";
            db_filepath = "../data/database_videos/" + Object.keys(ranked_scores)[0] + "/" + Object.keys(ranked_scores)[0] + ".mp4";

            $.ajax({
                data: JSON.stringify({ "filename": filename }),
                contentType: 'application/json',
                url: 'http://localhost:5000/convert_to_mp4',
                type: 'POST',
                success: function(result) {
                    console.log("Successfully converted query video to mp4")
                }
            }).then(function() {
                // Update query video
                var query_video = videojs('query-video');
                query_video.src(query_filepath);

                // Update match video
                var match_video = videojs('match-video');
                match_video.src(db_filepath);

                // Undisable slider
                document.getElementById("myFrameSlider").disabled = false;
            });
        });
    });
    </script>
</body>

</html>