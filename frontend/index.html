<!DOCTYPE html>
<html>

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="">
    <title>AV-Query</title>
    <!-- Custom Video JS -->

    <head>
        <link href="https://vjs.zencdn.net/7.5.5/video-js.css" rel="stylesheet" />
    </head>
</head>

<body>
    <div id="query">
        <form>
            <div class="form-group">
                <label for="query-file">Query</label>
                <input type="text" class="form-control-file" id="query-file" placeholder="Directory containing query files">
                <button type="button" class="form-control-button" id="query-submit-button">Submit Query</button>
            </div>
        </form>
    </div>
    <div id="matched-videos">
        <div class="row">
            <div class=".col-md-6">
                <ul class="list-group">
                    <li class="list-group-item" id="video3">Flowers.rgb <span class="score" id="score1">100%</span></li>
                    <li class="list-group-item" id="video3">Cars.rgb <span class="score" id="score2">80%</span></li>
                    <li class="list-group-item" id="video3">Movie.rgb <span class="score" id="score3">70%</span></li>
                </ul>
            </div>
        </div>
    </div>
    <div id="query-video">
        <video id="query-video" class="video-js" controls preload="auto" width="352" height="288" data-setup='{ "controlBar" : false }'>
        </video>
        <video id="match-video" class="video-js" controls preload="auto" width="352" height="288" data-setup='{ "controlBar" : false }'>
        </video>
        <input type="range" min="0" max="599" value="300" id="myFrameSlider" disabled style="width: 352px;">
    </div>
    <canvas id="myChart" width="352" height="100"></canvas>
    <!-- Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://vjs.zencdn.net/7.5.5/video.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <script>
    var sliderEle = document.getElementById('myFrameSlider');
    if (sliderEle != null) {
        var slider = document.getElementById('myFrameSlider');
        slider.oninput = function() {
            // Move in video to what second we are in (at 30fps) according to the slider
            sliderValue = parseInt(this.value);
            secondsValue = sliderValue / 30;
            var video = videojs('match-video');
            video.currentTime(secondsValue);
        }
    }
    </script>
    <script>
    var videoEle = document.getElementById('match-video');
    if (videoEle != null) {
        var video = videojs('match-video');
        video.on("timeupdate", function() {
            var slider = document.getElementById('myFrameSlider');
            slider.value = video.currentTime() * 30;
        });
    }
    </script>
    <script>
    helper = [
        0.35781122120365116,
        0.3788545040759598,
        0.39103100741674435,
        0.4038796628715906,
        0.4219177976359687,
        0.45406801156089094,
        0.4817931988517644,
        0.515401797793112,
        1,
        0.5290531219321039,
        0.5073469567121657,
        0.49587857044491945,
        0.4872318599476778,
        0.47947199285384035,
        0.45974055408424286,
        0.4329018640324922,
        0.41471178737159886,
        0.40882466024507,
        0.4125294201582652,
        0.41957429586765205,
        0.42312583971466655,
        0.43142477781032884,
        0.435275150362726,
        0.4334987144098901,
        0.43185655116103205,
        0.42954608118582804,
        0.42955685357224616,
        0.42770702607575783,
        0.4227086815168666,
        0.40896995988150553,
        0.39740569864917685
    ];

    // Set chart defaults for styling
    Chart.defaults.global.legend.display = false;
    Chart.defaults.scale.ticks.display = false;
    Chart.defaults.scale.gridLines.display = false;
    Chart.defaults.scale.gridLines.tickMarkLength = 0;

    var labels = Array.from(Array(31).keys())
    var ctx = document.getElementById('myChart').getContext('2d');
    var myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                data: helper,
                fill: true,
                pointRadius: 0,
            }],
        },
    });
    myChart.canvas.parentNode.style.height = '100px';
    myChart.canvas.parentNode.style.width = '352px';
    </script>
    <!-- Get calculating rank functions -->
    <script type="text/javascript" src="calculate_scores.js"></script>
    <!-- On button click! -->
    <script>
    $("#query-submit-button").click(function() {
        filename = $("#query-file").val();
        $.when(
            $.ajax({
                data: JSON.stringify({ "filename": filename + '.wav' }),
                contentType: 'application/json',
                url: 'http://localhost:5000/audio',
                type: 'POST',
                success: function(result) {
                    console.log(result)
                }
            }),
            $.ajax({
                data: JSON.stringify({ "filename": filename }),
                contentType: 'application/json',
                url: 'http://localhost:5000/color',
                type: 'POST',
                success: function(result) {
                    console.log(result)
                }
            }),
            $.ajax({
                data: JSON.stringify({ "filename": '../data/query/' + filename }),
                contentType: 'application/json',
                url: 'http://localhost:5000/edge_detection',
                type: 'POST',
                success: function(result) {
                    console.log(result)
                }
            })).then(function(wav_scores, color_scores, edge_scores) {

            // Calculate ranked scores for top three 
            final_scores = calculate_cum_scores(wav_scores[0], edge_scores[0], color_scores[0]);
            ranked_files = get_top_ranked_files(final_scores);
            ranked_scores = convert_dist_to_scores(ranked_files);

            // Create query mp4
            query_filepath = "../data/query/" + filename + "/" + filename + ".mp4";
            $.ajax({
                data: JSON.stringify({ "filename": filename }),
                contentType: 'application/json',
                url: 'http://localhost:5000/convert_to_mp4',
                type: 'POST',
                success: function(result) {
                    console.log("Successfully converted query video to mp4")
                }
            }).then(function() {
                // Update query video
                var query_video = videojs('query-video');
                query_video.src("../data/query/" + filename + "/" + filename + ".mp4");
                // Update match video
                var match_video = videojs('match-video');
                match_video.src("../data/database_videos/sports/sports.mp4");

                // Undisable slider
                document.getElementById("myFrameSlider").disabled = false;
            });
        });
    });
    </script>
</body>

</html>